---
title: "221220 - Database"
output: html_document
date: "2022-12-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Input

```{r}
#Libraries
library(pacman)
p_load(tidyverse, janitor, here, haven, labelled, sjmisc, skimr,
       stargazer, purr, conflicted)

#devtools::install_github("DiogoFerrari/occupar")
library(occupar)

```

```{r}
#Packages conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")

options(max.print=999999)
options(scipen=999)
```

## ISSP Social Inequality 2019

```{r}
#Load database
issp_2019_original = read_dta(here("Input", "ZA7600_v3-0-0.dta"))  %>% 
  clean_names()

```

# Processing

## Complete database

```{r}
#Select
issp_2019 = issp_2019_original %>% 
  filter(country==152) %>% 
  select(studyno:educyrs, degree:union, isco08, cl_inc, caseid:partials)

#Rename
issp_2019 = issp_2019 %>% 
  rename(ib_fam = v1,
          ib_edup = v2,
          ib_edu = v3,
          ib_work = v4,
          ib_ppl = v5,
          ib_con = v6,
          ib_bri = v7,
          ib_race = v8,
          ib_rel = v9,
          ib_sex = v10,
          p_ineq = v21,
          j_ineq = v50,
         b_red_p = v22,
          b_red_m = v24,
          j_red_d = v26,
          j_red_f = v27,
          b_tax = v28,
          p_tax = v29)

#Reorder
issp_2019 = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("p_"),
         starts_with("b_"),
         starts_with("j_"),
         everything())

```


```{r}
#Missing values and inverting polarity
issp_2019 = issp_2019 %>% 
  mutate(across(ib_fam:j_ineq, ~replace(., .<0 , NA)),
         across(c(cl_inc, educyrs, isco08, emprel, nsup, v61, v41, v42), ~replace(., .<0 , NA)),
         across(ib_fam:ib_sex,  ~ 6 - .),
         across(c(p_ineq, b_red_p, b_red_m, j_red_d, b_tax),  ~ 6 - .))


#Reorder
issp_2019 = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("p_"),
         starts_with("b_"),
         j_ineq,
         j_red_d,
         j_red_f,
         everything())
```


## Attitudes towards inequality database

```{r}

#Select and listwise
chi_net = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("p_"),
         starts_with("b_"),
         j_ineq,
         j_red_d,
         j_red_f) %>% 
  na.omit()

names(chi_net)

```

## Networks for NCTs

### Income

```{r}

#Select and listwise
chi_income = issp_2019 %>% 
  select(ib_fam:j_red_f,
         cl_inc) %>% 
  rename(income_h = cl_inc) %>% 
  na.omit()

#Dummy
chi_income = chi_income %>% 
  mutate(income_h = ifelse(income_h<=448000, 0, 1)) #448000

#Split
chi_income = chi_income %>% 
  group_split(income_h, .keep = FALSE)

income_0 = chi_income[[1]]
income_1 = chi_income[[2]]
```


### Education

```{r}

#Select and listwise
chi_education = issp_2019 %>% 
  select(ib_fam:j_red_f,
         educyrs) %>% 
  na.omit()

#Dummy
chi_education = chi_education %>% 
  mutate(education = ifelse(educyrs<=11, 0, 1)) %>% 
  select(-educyrs)
  #11 years (Incomplete secondary) 

#Split
chi_education = chi_education %>% 
  group_split(education, .keep = FALSE)

education_0 = chi_education[[1]]
education_1 = chi_education[[2]]
```


### EGP social class

```{r}

#Select and listwise
chi_class = issp_2019 %>% 
  select(ib_fam:j_red_f,
         isco08, emprel, nsup)

#ISCO08 - Code (isco08_code)
chi_class = chi_class %>% 
  separate(isco08, c("isco08_code", "isco08_label"), remove = FALSE) %>% 
  mutate(isco08_code = as.numeric(paste0(isco08_code)),
         isco08_label = ifelse(is.na(isco08_code), NA, isco08_label))

#Self-employed (self_employed)
chi_class = chi_class %>% 
  mutate(self_employed_ = as.numeric(emprel)) %>% 
  mutate(self_employed = case_when(self_employed_==3 ~ 0,
                               self_employed_>=4 & self_employed_<=7 ~ 1,
                               TRUE ~ NA_real_))

#Number of employees (n_employees)
chi_class = chi_class %>% 
  mutate(n_employees = ifelse(nsup<0, NA, nsup))

#ISCO08 - ISCO88 - EGP
chi_class = chi_class %>% 
  mutate(isco88_code = isco08to88(isco08_code, display.nas = FALSE)) %>% 
  mutate(social_class_3 = isco88toEGP(isco88_code, n.employees=n_employees, self.employed=self_employed, n.classes=3)) 

#Drop IV.c+VII.b  Farm workers 
chi_class = chi_class %>% 
  filter(social_class_3!="IV.c+VII.b  Farm workers")


#Select and listwise
chi_class = chi_class %>% 
  select(ib_fam:j_red_f,
         social_class_3) %>% 
  na.omit()

#Dummy
chi_class = chi_class %>% 
  mutate(social_class_3 = ifelse(
                  social_class_3=="V+VI+VI.a Manual workers", 0, 1)) #V+VI+VI.a Manual workers

#Split
chi_class = chi_class %>% 
  group_split(social_class_3, .keep = FALSE)

class_0 = chi_class[[1]]
class_1 = chi_class[[2]]


```

## Summary

```{r}
#chi_net
summary_chi_net  = chi_net %>% 
  skim() %>% 
  as.data.frame()

stargazer(as.data.frame(chi_net), type = "text", nobs = TRUE)
```
# Output

```{r}

#Save objects
save(chi_net,
     income_0, income_1,
     education_0, education_1,
     class_0, class_1,
     file = here("Input", "Chile_data.RData"))

```


