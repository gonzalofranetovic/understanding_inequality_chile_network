---
title: "221220 - mgm_chile"
output: html_document
date: "2022-12-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Input

```{r message=FALSE, warning=FALSE}
library(pacman)
p_load(tidyverse, janitor, here, haven, labelled, sjmisc, skimr, ggplot2, jtools,
       stargazer, qgraph, Matrix, igraph, psychTools, NetworkComparisonTest, bootnet,
       rio, compute.es, foreign, matrixcalc, RColorBrewer, EGAnet, kableExtra)
```

```{r}
load(file = here("Input", "Chile_data.RData"))
names(chi_net)
```

## Create objects

```{r}
shortnames <- names(chi_net)

longnames <- c(
  "Inequality belief - wealthy family",
  "Inequality belief - parental education",
  "Inequality belief - education",
  "Inequality belief - work",
  "Inequality belief - people",
  "Inequality belief - politics",
  "Inequality belief - bribes",
  "Inequality belief - race",
  "Inequality belief - religion",
  "Inequality belief - sex",
  "Perception of large income inequality",
  "Perception of tax regressivity",
  "Belief in public redistribution",
  "Belief in market redistribution",
  "Belief in progressive taxation",
  "Judgment about existing unfair distribution",
  "Judgment about political disinterest in redistribution",
  "Judgment about the failure of public redistribution")


stargazer(as.data.frame(chi_net), type = "text", nobs = TRUE)

  
```

# Processing

## Network estimation

### Full network - GGM

```{r}
# Estimate partial correlation network:
cor_chi = cor(chi_net)
ggm_chi <- EBICglasso(S = cor_chi, n = nrow(chi_net))

net_pcor <- estimateNetwork(chi_net, default = "EBICglasso")
plot(net_pcor)



# Communities
ega_chi = EGA(chi_net)
ega_chi$wc

totalgroup_comm <- list(
 " "=c(1:5),
 " "=c(6:10),
 " "=c(11,13,14,15,17),
 " "=c(12,16,18))
       
totalgroup_cols <- c("#DECBE4","#FED9A6","#CCEBC5","#FDDAEC","#FFFFCC")
```
### EGA

```{r}
# Plot network
pdf(file = here("Output", "network.pdf"), paper = "USr", height = 9, width = 12)
ggm_chi_net = qgraph(ggm_chi, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames,nodeNames = longnames,
  cut = 0.10, 
  #minimum = 0.05, 
  maximum = 1, 
  GLratio=3,
  details = FALSE, vsize=7.0, label.cex=0.8, label.scale=FALSE,
  groups=totalgroup_comm, color=totalgroup_cols,
  legend = TRUE, legend.cex = 0.3, borders = FALSE)
dev.off()

# Plot centrality
centrality(ggm_chi_net)
centrality_graph = centralityPlot(ggm_chi_net, labels = longnames, 
                                      orderBy = "Strength") + 
  geom_vline(xintercept=0, linetype="dotted") +
  scale_x_continuous() +
  theme_nice() + 
  theme(axis.text.y=element_text(hjust=1))

ggsave(here("Output", "centrality.jpg"), centrality_graph,
        height = 4)

```

### Sociodemographic networks - EGA

#### Manual


```{r}
#Fit
EGA_income_0 = EGA(income_0)
EGA_income_1 = EGA(income_1)
EGA_education_0 = EGA(education_0)
EGA_education_1 = EGA(education_1)
EGA_class_0 = EGA(class_0)
EGA_class_1 = EGA(class_1)
```

##### Income

```{r}

group_income_0 <- list(
 " "=c(1:5),
 " "=c(8,9,10),
 " "=c(11,13,14),
 " "=c(6,7),
 " "=c(12,15))

group_income_1 <- list(
 " "=c(1:5),
 " "=c(6,7, 8,9,10),
 " "=c(11,13,14,12,15))

cor_chi_income_0 = cor(income_0)
cor_chi_income_1 = cor(income_1)

ggm_chi_income_0 <- EBICglasso(S = cor_chi_income_0, n = nrow(income_0))
ggm_chi_income_1 <- EBICglasso(S = cor_chi_income_1, n = nrow(income_1))

names(income_0)


pdf(here("Output", "income.pdf"), paper = "USr", 
    height = 9, width = 12)

L<-averageLayout(ggm_chi_income_0,ggm_chi_income_1)

lmat <- matrix(1:2, 1)
lo <- layout(lmat, width = c(1, 1))

graph_income_0<-qgraph(ggm_chi_income_0, 
  layout = L, theme = "Borkulo", 
  labels = shortnames,
  cut = 0.10, 
  label.scale=FALSE,
  groups=group_income_0, color=totalgroup_cols,
  legend = FALSE, borders = FALSE, details = FALSE, vsize=6.0,
  title = "Low income")
graph_income_1<-qgraph(ggm_chi_income_1, 
  layout = L, theme = "Borkulo", 
  labels = shortnames,
  cut = 0.10, 
  label.scale=FALSE,
  groups=group_income_1, color=totalgroup_cols,
  legend = FALSE, borders = FALSE, details = FALSE, vsize=6.0,
  title = "High income")

dev.off()


EGA_income_0$wc
EGA_income_1$wc
comp_egas_income

EGA_education_0$wc
EGA_education_1$wc
EGA_class_0$wc
EGA_class_1$wc
```

#### CompareEGA

```{r}

EGA_income_0 = EGA(income_0)
EGA_income_1 = EGA(income_1)
EGA_education_0 = EGA(education_0)
EGA_education_1 = EGA(education_1)
EGA_class_0 = EGA(class_0)
EGA_class_1 = EGA(class_1)

#EGA list
data_egas_income <- lapply(ls(pattern="^EGA_income"), function(x) get(x))

#Compare EGAs
comp_egas_income = compare.EGA.plots(
  input.list = data_egas_income,
  base.plot = 1,
  labels = c("Low", "High"),
  rows = 1, columns = 2,
  plot.args = list(
    plot.type="qgraph",
    #vsize = 2, label.size = 2, edge.size = 0.2,
    legend.position = "none", legend.size = NA,
    borders = FALSE))


pdf(file = here("Output", "network_income.pdf"), paper = "USr", height = 9, width = 12)
comp_egas_income_plot1 = qgraph(comp_egas_income$individual.plots$Low, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames,nodeNames = longnames,
  cut = 0.10, 
  #minimum = 0.05, 
  maximum = 1, 
  GLratio=3,
  details = FALSE, vsize=7.0, label.cex=0.8, label.scale=FALSE,
  #groups=totalgroup_comm, color=totalgroup_cols,
  legend = FALSE, legend.cex = 0.3, borders = FALSE)
dev.off()

```


### Communities

```{r}

```
## Plot

```{r}
#enables theme colorblind because we don't need to specify edge.color
inputGraphMGM <- mgmFit$pairwise$wadj
signsGraphMGM <- mgmFit$pairwise$signs
signsGraphMGM[which(is.na(signsGraphMGM))] <- 1
inputGraphMGM <- inputGraphMGM*signsGraphMGM

# refined, no minimum 
pdf(file = '../Output/H1/MGM_nomin.pdf',paper = "USr", height = 9, width = 12)
GraphMGM<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames, nodeNames = longnames,
  cut = 0.10, maximum = 1, 
  details = FALSE, vsize=6.0,
  groups=Totalgroup_comm, color= Totalgroup_cols,
  legend = TRUE, legend.cex = 0.3, borders = FALSE)
dev.off()

# refined,  minimum = 0.5
pdf(file = '../Output/H1/MGM_min_05.pdf',paper = "USr", height = 9, width = 12)
GraphMGM<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames,nodeNames = longnames,
  cut = 0.10, minimum = 0.05, maximum = 1, 
  details = FALSE, vsize=6.0, 
  groups=Totalgroup_comm, color= Totalgroup_cols,
  legend = TRUE, legend.cex = 0.3, borders = FALSE)
dev.off()

# refined,  minimum = 0.10
pdf(file = '../Output/H1/MGM_min_10.pdf',paper = "USr", height = 9, width = 12)
GraphMGM<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "Borkulo", 
  labels = shortnames,nodeNames = longnames,
  cut = 0.10, minimum = 0.10, maximum = 1, 
  details = FALSE, vsize=6.0, legend = TRUE,
  groups=Totalgroup_comm, color= Totalgroup_cols,
  legend.cex = 0.3, borders = FALSE)
dev.off()
```

### Centrality estimates

```{r}
#graph with complete labels for centrality plot
GraphMGMCENT<-qgraph(inputGraphMGM, 
  layout = "spring", theme = "colorblind",
  labels = longnames, minimum = 0,
  cut = 0.10, maximum = 1, details = TRUE,
  legend = FALSE)

#centrality Total
centMGM <- centralityTable(GraphMGMCENT,standardized = FALSE)

#CentralityPlot Total
centrality_table = centralityPlot(GraphMGMCENT, include = c("Strength"), scale = "raw",
               orderBy = "Strength") + theme_nice() + theme(axis.text.y=element_text(hjust=1))

ggsave(here("Output", "H1", "Centrality_Table.jpg"), centrality_table)
```

### ASPL

```{r}
#Shortest Path Lenght
SPLMGM <- centrality(GraphMGM, weighted = TRUE)$ShortestPathLengths
SPLMGM <- SPLMGM[upper.tri(SPLMGM)]
#Average shortest path length
ASPL_MGM <- mean(SPLMGM)
```
ASPL (Weighted) m= 19.90601

## Bootstrap

#### Edge accuracy

```{r}
#edge weight accuracy: non parametric bootstrap with 8 cores
#edgeacc =  bootnet(CHI, nBoots = 1000, nCores = 8, 'mgm')

#load the object instead:
edgeacc = readRDS(here("Input", "edgeacc.rds"))

#plot 1
pdf('../Output/H1/robustness/edge_accuracy.pdf', height = 70, width = 50)
plot(edgeacc, labels = longnames, order = "sample")
dev.off()

#Plot 2
pdf('../Output/H1/robustness/edge_accuracy_CI.pdf', height = 70, width = 50)
plot(edgeacc, plot = "interval", split0 = TRUE, order="sample", labels=longnames)
dev.off()

#summary
saummary_edgeacc = summary(edgeacc, statistics = c("edge", "strength"), 
                            perNode = FALSE, rank = FALSE) 
```

#### Centrality stability

```{r}
# case dropping bootstrap
#centstab = bootnet(CHI, nBoots = 1000, 'mgm', type = "case", nCores = 8)

#load the object instead:
centstab = readRDS(here("Input", "centstab.rds"))

#plot 1
pdf('../Output/H1/robustness/Centrality_stability.pdf', height = 70, width = 50)
plot(centstab, "Strength", perNode = TRUE, labels = longnames,
     subsetRange = c(100,50))
dev.off()

#Plot 2
pdf('../Output/H1/robustness/Centrality_stability_CI.pdf', height = 70, width = 50)
plot(centstab, "Strength", CIstyle =  "quantiles")
dev.off()

#CS-coefficient (result should be above 0.25, better if above 0.5)
corstab = corStability(centstab)
```

#### Testing Edge and centrality differences

```{r}
# Test: difference of weight ties 2-3 vs 4-5
differenceTest(edgeacc, 2--3, 3--4, "strength")

# Plot test results for every edge weight in the network
pdf('../Output/H1/robustness/test_edges.pdf', height = 70, width = 50)
plot(edgeacc, "edge", plot = "difference", onlyNonZero = TRUE, order = "sample", 
     labels = T)
dev.off()
```

```{r}
# Test: difference of strength of node 2 vs 3 (if the bootstrapped CI include 0, they do not differ)
differenceTest(edgeacc, 2, 3, "strength")

# Plot test results for every edge weight in the network
pdf('../Output/H1/robustness/test_strenghts.pdf', height = 70, width = 50)
plot(edgeacc, "strength", order = "mean", labels = T)
dev.off()
```


## H1

```{r}
#small world network
CHI_small_core = smallworldness(mgmFit$pairwise$wadj, B = 1000)
CHI_small_core

```
comment: 
- smallworldness > 1 -> small world network
- rnd values > 1 -> small world network
- averagelength_target (Unweighted)


# Output

## Export heavy objects

```{r}
#communities
saveRDS(CommunityStabTotal, here("Input", "CommunityStabTotal.rds"))
#bootnet
saveRDS(edgeacc, here("Input","edgeacc.rds"))
saveRDS(centstab, here("Input", "centstab.rds"))
```

## Edge weight to excel

```{r}
##only upper triangle without edge weigths 0 for readability
EdgeWeight_Total_half<-upper.triangle(inputGraphMGM)
EdgeWeight_Total_half[EdgeWeight_Total_half == 0] <- NA
EdgeWeightsExcel_half<- list("mgm" = EdgeWeight_Total_half)
write.xlsx(EdgeWeightsExcel_half, "../Output/H1/EdgeWeightsExcel_half.xlsx",
           colWidths = "auto", rowNames = TRUE)
```
