---
title: "221220 - Database"
output: html_document
date: "2022-12-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Input

```{r}
#Libraries
library(pacman)
p_load(tidyverse, janitor, here, haven, labelled, sjmisc, skimr,
       stargazer, purr, conflicted)

#devtools::install_github("DiogoFerrari/occupar")
library(occupar)

```

```{r}
#Packages conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")

options(max.print=999999)
options(scipen=999)
```

## ISSP Social Inequality 2019

```{r}
#Load database
issp_2019_original = read_dta(here("Input", "ZA7600_v3-0-0.dta"))  %>% 
  clean_names()

```

# Processing

## Complete database

```{r}
#Select
issp_2019 = issp_2019_original %>% 
  filter(country==152) %>% 
  select(studyno:educyrs, degree:union, isco08, cl_inc, caseid:partials)

#Rename
issp_2019 = issp_2019 %>% 
  rename(ib_weafam = v1,
          ib_edupar = v2,
          ib_edu = v3,
          ib_work = v4,
          ib_people = v5,
          ib_pol = v6,
          ib_bribes = v7,
          ib_race = v8,
          ib_relig = v9,
          ib_sex = v10,
          ineq_per = v21,
          ineq_jud = v50,
         red_pub = v22,
          red_pri = v24,
          red_unca = v26,
          red_unsu = v27,
          tax_bel = v28,
          tax_per = v29,
          pay_resp = v44,
          pay_educ = v45,
          pay_need = v46,
          pay_merit = v47)

#Reorder
issp_2019 = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("ineq_"),
         starts_with("red_"),
         starts_with("tax_"),
         starts_with("pay_"),
         everything())

```


```{r}
#Missing values and inverting polarity
issp_2019 = issp_2019 %>% 
  mutate(across(ib_weafam:pay_merit, ~replace(., .<0 , NA)),
         across(c(cl_inc, educyrs, isco08, emprel, nsup, v61, v41, v42), ~replace(., .<0 , NA)),
         across(ib_weafam:ib_sex,  ~ 6 - .),
         across(c(ineq_per, red_pub, red_pri, red_unca, tax_bel),  ~ 6 - .),
         across(pay_resp:pay_merit,  ~ 6 - .))


#Reorder
issp_2019 = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("ineq_"),
         starts_with("red_"),
         starts_with("tax_"),
         starts_with("pay_"),
         everything())

```


## Attitudes towards inequality database

```{r}

#Select and listwise
CHI_net = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("ineq_"),
         starts_with("red_"),
         starts_with("tax_"),
         starts_with("pay_")) %>% 
  na.omit()

CHI_net_r = issp_2019 %>% 
  select(starts_with("ib_"),
         starts_with("ineq_"),
         starts_with("red_"),
         starts_with("tax_")) %>% 
  na.omit()


names(CHI_net)

```

## Networks for NCTs

### Income

```{r}

#Select and listwise
CHI_income = issp_2019 %>% 
  select(ib_weafam:tax_per,
         cl_inc) %>% 
  rename(income_h = cl_inc) %>% 
  na.omit()

#Dummy
CHI_income = CHI_income %>% 
  mutate(income_h = ifelse(income_h<=448000, 0, 1)) #448000

#Split
CHI_income = CHI_income %>% 
  group_split(income_h, .keep = FALSE)

income_0 = CHI_income[[1]]
income_1 = CHI_income[[2]]
```


### Education

```{r}

#Select and listwise
CHI_educyrs = issp_2019 %>% 
  select(ib_weafam:tax_per,
         educyrs) %>% 
  na.omit()

#Dummy
CHI_educyrs = CHI_educyrs %>% 
  mutate(educyrs = ifelse(educyrs<=11, 0, 1)) #11 years (Incomplete secondary)

#Split
CHI_educyrs = CHI_educyrs %>% 
  group_split(educyrs, .keep = FALSE)

edu_0 = CHI_educyrs[[1]]
edu_1 = CHI_educyrs[[2]]
```


### EGP social class

```{r}

#Select and listwise
CHI_egpclass = issp_2019 %>% 
  select(ib_weafam:tax_per,
         isco08, emprel, nsup)

#ISCO08 - Code (isco08_code)
CHI_egpclass = CHI_egpclass %>% 
  separate(isco08, c("isco08_code", "isco08_label"), remove = FALSE) %>% 
  mutate(isco08_code = as.numeric(paste0(isco08_code)),
         isco08_label = ifelse(is.na(isco08_code), NA, isco08_label))

#Self-employed (self_employed)
CHI_egpclass = CHI_egpclass %>% 
  mutate(self_employed_ = as.numeric(emprel)) %>% 
  mutate(self_employed = case_when(self_employed_==3 ~ 0,
                               self_employed_>=4 & self_employed_<=7 ~ 1,
                               TRUE ~ NA_real_))

#Number of employees (n_employees)
CHI_egpclass = CHI_egpclass %>% 
  mutate(n_employees = ifelse(nsup<0, NA, nsup))

#ISCO08 - ISCO88 - EGP
CHI_egpclass = CHI_egpclass %>% 
  mutate(isco88_code = isco08to88(isco08_code, display.nas = FALSE)) %>% 
  mutate(social_class_3 = isco88toEGP(isco88_code, n.employees=n_employees, self.employed=self_employed, n.classes=3)) 

#Drop IV.c+VII.b  Farm workers 
CHI_egpclass = CHI_egpclass %>% 
  filter(social_class_3!="IV.c+VII.b  Farm workers")


#Select and listwise
CHI_egpclass = CHI_egpclass %>% 
  select(ib_weafam:tax_per,
         social_class_3) %>% 
  na.omit()

#Dummy
CHI_egpclass = CHI_egpclass %>% 
  mutate(social_class_3 = ifelse(
                  social_class_3=="V+VI+VI.a Manual workers", 0, 1)) #V+VI+VI.a Manual workers

#Split
CHI_egpclass = CHI_egpclass %>% 
  group_split(social_class_3, .keep = FALSE)

egpclass_0 = CHI_egpclass[[1]]
egpclass_1 = CHI_egpclass[[2]]


```

### Subjective social class

```{r}
#Select and listwise
CHI_subclass = issp_2019 %>% 
  select(ib_weafam:tax_per,
         v61) %>% 
  rename(subclass = v61) %>% 
  na.omit()

#Dummy
CHI_subclass = CHI_subclass %>% 
  mutate(subclass = ifelse(subclass<=2, 0, 1)) #3. Lower middle class

#Split
CHI_subclass = CHI_subclass %>% 
  group_split(subclass, .keep = FALSE)

subclass_0 = CHI_subclass[[1]]
subclass_1 = CHI_subclass[[2]]
```


### Subjective social mobility

```{r}

#Social mobility
CHI_socmob  = issp_2019
CHI_socmob$socmob = CHI_socmob$v42 - CHI_socmob$v41

#Select and listwise
CHI_socmob = CHI_socmob %>% 
  select(ib_weafam:tax_per,
         socmob) %>% 
  na.omit()

#Dummy
CHI_socmob = CHI_socmob %>% 
  mutate(socmob = ifelse(socmob>=0, 1, 0)) #0
                 
#Split
CHI_socmob = CHI_socmob %>% 
  group_split(socmob, .keep = FALSE)

socmob_0 = CHI_socmob[[1]]
socmob_1 = CHI_socmob[[2]]
```

## Summary

```{r}
#CHI_net
summary_CHI_net  = CHI_net %>% 
  skim() %>% 
  as.data.frame()

stargazer(as.data.frame(CHI_net), type = "text", nobs = TRUE)
```
# Output

```{r}

#Save objects
save(CHI_net, CHI_net_r,
     income_0, income_1,
     edu_0, edu_1,
     egpclass_0, egpclass_1,
     subclass_0, subclass_1,
     socmob_0, socmob_1, 
     file = here("Input", "Chile_data.RData"))

```


